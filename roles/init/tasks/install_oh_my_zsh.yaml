- name: Download Oh-my-zsh installer
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
    dest: "/home/{{ main_user }}/install-oh-my-zsh.sh"
    mode: '0755'
    owner: "{{ main_user }}"
    group: "{{ main_user }}"
  become_user: "{{ main_user }}"
  register: downloaded_script
  changed_when: downloaded_script.changed

- name: Install Oh-my-zsh (with verification)
  ansible.builtin.shell: |
    export ZSH="/home/{{ main_user }}/.oh-my-zsh"
    bash "/home/{{ main_user }}/install-oh-my-zsh.sh" --unattended
  args:
    executable: /bin/bash
    creates: "/home/{{ main_user }}/.oh-my-zsh"
  become: true
  when: downloaded_script.changed

- name: Remove install-oh-my-zsh.sh
  ansible.builtin.file:
    path: "/home/{{ main_user }}/install-oh-my-zsh.sh"
    state: absent

- name: Clone Powerlevel10k
  ansible.builtin.git:
    repo: https://github.com/romkatv/powerlevel10k.git
    dest: "/home/{{ main_user }}/.oh-my-zsh/custom/themes/powerlevel10k"
    depth: 1
    update: true
  become: true

- name: Settings Oh-My-ZSH
  become: true
  block:
    - name: Clone repository fzf-zsh-plugin
      ansible.builtin.git:
        repo: https://github.com/unixorn/fzf-zsh-plugin.git
        dest: "/home/{{ main_user }}/.oh-my-zsh/custom/plugins/fzf-zsh-plugin"
        depth: 1

    - name: Create .fzf directiry
      ansible.builtin.file:
        path: "/home/{{ main_user }}/.fzf"
        owner: "{{ main_user }}"
        group: "{{ main_user }}"
        mode: "0755"
        state: directory

    - name: Touch file .fzf.zsh
      ansible.builtin.file:
        path: "/home/{{ main_user }}/.fzf/fzf.zsh"
        owner: "{{ main_user }}"
        group: "{{ main_user }}"
        mode: "0644"
        state: touch

    - name: Clone repository zsh-autosuggestions
      ansible.builtin.git:
        repo: https://github.com/zsh-users/zsh-autosuggestions.git
        dest: "/home/{{ main_user }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"

    - name: Clone repository zsh-syntax-highlighting
      ansible.builtin.git:
        repo: https://github.com/zsh-users/zsh-syntax-highlighting.git
        dest: "/home/{{ main_user }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"

#    - name: Find files in .oh-my-zsh
#      ansible.builtin.find:
#        paths: "/home/{{ main_user }}/.oh-my-zsh"
#        file_type: any
#        recurse: yes
#      register: folder_contents
#
#    - name: Change owner .oh-my-zsh
#      ansible.builtin.file:
#        path: "{{ item.path }}"
#        owner: "{{ main_user }}"
#        group: "{{ main_user }}"
#      loop: "{{ folder_contents.files }}"
#      no_log: yes
